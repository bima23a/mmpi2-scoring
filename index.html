<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MMPI-2 Professional Scoring System</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root { 
            --primary: #2c3e50; 
            --accent: #3498db; 
            --danger: #c0392b; 
            --success: #27ae60; 
            --warning: #f39c12;
            --bg: #f4f6f8; 
            --text: #2c3e50;
        }
        * { box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 0; background: var(--bg); color: var(--text); font-size: 14px; display: flex; min-height: 100vh; }
        
        /* LAYOUT */
        .sidebar { width: 260px; background: var(--primary); color: #fff; position: fixed; height: 100%; overflow-y: auto; padding: 20px; z-index: 1000; box-shadow: 2px 0 5px rgba(0,0,0,0.1); }
        .main-content { margin-left: 260px; flex: 1; padding: 40px; width: calc(100% - 260px); }
        
        /* SIDEBAR NAV */
        .sidebar h3 { border-bottom: 1px solid rgba(255,255,255,0.2); padding-bottom: 15px; margin-top: 0; font-size: 18px; letter-spacing: 1px; }
        .nav-item { display: block; padding: 10px 15px; color: #bdc3c7; text-decoration: none; border-radius: 4px; margin-bottom: 2px; transition: 0.2s; cursor: pointer; }
        .nav-item:hover { background: rgba(255,255,255,0.1); color: #fff; transform: translateX(5px); }
        .nav-group { font-size: 11px; text-transform: uppercase; color: #95a5a6; margin-top: 20px; margin-bottom: 5px; font-weight: bold; }

        /* CARDS & CONTAINERS */
        .card { background: #fff; padding: 25px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); margin-bottom: 25px; border: 1px solid #e0e0e0; break-inside: avoid; }
        .card h3 { margin-top: 0; border-bottom: 2px solid var(--primary); padding-bottom: 10px; color: var(--primary); font-size: 16px; text-transform: uppercase; }

        /* HEADER REPORT STYLE */
        .report-header { text-align: center; border: 3px solid #000; padding: 15px; margin-bottom: 30px; background: #fff; }
        .report-header h1 { margin: 0; font-size: 24px; text-transform: uppercase; }
        .report-header p { margin: 5px 0 0; color: #555; font-style: italic; font-size: 12px; }

        /* UPLOAD ZONE */
        .upload-area { border: 2px dashed #bdc3c7; padding: 40px; text-align: center; border-radius: 8px; cursor: pointer; background: #fff; transition: 0.3s; }
        .upload-area:hover { border-color: var(--accent); background: #ebf5fb; }

        /* TABLES */
        table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 12px; }
        th { background: #ecf0f1; padding: 8px; text-align: left; border-bottom: 2px solid #bdc3c7; color: #2c3e50; font-weight: 700; }
        td { padding: 6px 8px; border-bottom: 1px solid #eee; }
        tr:hover td { background: #f9f9f9; }
        
        /* VALIDITY GRID */
        .validity-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 15px; margin-bottom: 20px; }
        .v-box { padding: 15px; border: 1px solid #eee; border-radius: 6px; text-align: center; background: #fff; }
        .v-box .label { font-size: 11px; font-weight: bold; color: #7f8c8d; margin-bottom: 5px; }
        .v-box .value { font-size: 20px; font-weight: bold; color: var(--primary); }
        .v-box .desc { font-size: 10px; color: #95a5a6; }

        /* BADGES */
        .badge { display: inline-block; padding: 3px 8px; border-radius: 12px; font-size: 10px; font-weight: bold; color: #fff; }
        .bg-high { background-color: var(--danger); }
        .bg-warn { background-color: var(--warning); }
        .bg-norm { background-color: var(--success); }

        /* CHART */
        .chart-wrapper { height: 250px; width: 100%; position: relative; margin-bottom: 20px; }

        /* PRINT SETTINGS */
        @media print {
            @page { size: A4; margin: 1cm; }
            body { background: #fff; color: #000; display: block; font-family: 'Times New Roman', serif; }
            .sidebar, .btn, .upload-area, #uploadContainer, .no-print { display: none !important; }
            .main-content { margin: 0; padding: 0; width: 100%; }
            .card { box-shadow: none; border: 1px solid #000; margin-bottom: 15px; padding: 15px; page-break-inside: avoid; }
            .report-header { border: 2px solid #000; }
            h3 { border-bottom: 1px solid #000 !important; color: #000 !important; }
            .validity-grid { grid-template-columns: repeat(5, 1fr); gap: 10px; }
            .v-box { border: 1px solid #000; }
            th { background: #ddd !important; -webkit-print-color-adjust: exact; border-bottom: 1px solid #000; }
            tr.highlight { background-color: #ddd !important; -webkit-print-color-adjust: exact; }
            .chart-wrapper { height: 220px !important; }
        }
        
        .hidden { display: none; }
        .btn { padding: 10px 20px; background: var(--accent); color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; }
    </style>
</head>
<body>

<div class="sidebar">
    <h3>MMPI-2 ANALYST</h3>
    <div class="nav-group">Input Data</div>
    <div class="nav-item" onclick="document.getElementById('fileInput').click()">üìÇ Upload JSON</div>
    <div class="nav-item" onclick="location.reload()">üîÑ Reset System</div>
    
    <div class="nav-group">Navigasi Laporan</div>
    <a href="#validitas" class="nav-item">1. Validitas & Sikap</a>
    <a href="#klinis" class="nav-item">2. Profil Klinis</a>
    <a href="#content" class="nav-item">3. Skala Konten</a>
    <a href="#supp" class="nav-item">4. Skala Suplemen</a>
    <a href="#psy5" class="nav-item">5. PSY-5</a>
</div>

<div class="main-content">
    <div id="uploadContainer">
        <div class="card" style="text-align:center; padding: 60px;">
            <h1 style="color:var(--primary);">Sistem Skoring MMPI-2 Professional</h1>
            <p style="color:#7f8c8d; margin-bottom:30px;">Mendukung format standar (Nucular/Lsweatman) dengan logika TRIN, VRIN, & F-K Index.</p>
            <div class="upload-area" onclick="document.getElementById('fileInput').click()">
                <span style="font-size:40px;">üìÑ</span><br>
                <b>Klik untuk Pilih File JSON</b>
                <input type="file" id="fileInput" accept=".json" class="hidden" onchange="processFile(this)">
            </div>
            <div id="errorMsg" style="color:red; margin-top:20px; display:none;"></div>
        </div>
    </div>

    <div id="reportContainer" class="hidden">
        <div style="text-align:right; margin-bottom:20px;" class="no-print">
            <button class="btn" onclick="window.print()">üñ®Ô∏è Cetak Laporan PDF</button>
        </div>

        <div class="report-header">
            <h1>Laporan Hasil Tes Psikologis MMPI-2</h1>
            <p>RAHASIA - HANYA UNTUK KALANGAN PROFESIONAL (PSIKOLOG/PSIKIATER)</p>
        </div>

        <div class="card">
            <h3>Identitas Subjek</h3>
            <table style="border:none;">
                <tr>
                    <td width="150"><strong>Nama Lengkap</strong></td><td id="dNama">: -</td>
                    <td width="150"><strong>Tanggal Tes</strong></td><td id="dTanggal">: -</td>
                </tr>
                <tr>
                    <td><strong>Usia / Gender</strong></td><td id="dInfo">: -</td>
                    <td><strong>Pendidikan</strong></td><td id="dEdu">: -</td>
                </tr>
                <tr>
                    <td><strong>Pekerjaan</strong></td><td id="dJob">: -</td>
                    <td><strong>Validitas Profil</strong></td><td id="dValid status" style="font-weight:bold;">: -</td>
                </tr>
            </table>
        </div>

        <div class="card" id="validitas">
            <h3>1. Validitas & Sikap Tes</h3>
            <div class="validity-grid">
                <div class="v-box">
                    <div class="label">CANNOT SAY (?)</div>
                    <div class="value" id="valQ">0</div>
                    <div class="desc">Item Kosong</div>
                </div>
                <div class="v-box">
                    <div class="label">VRIN</div>
                    <div class="value" id="valVRIN">-</div>
                    <div class="desc">Konsistensi Acak</div>
                </div>
                <div class="v-box">
                    <div class="label">TRIN</div>
                    <div class="value" id="valTRIN">-</div>
                    <div class="desc">Konsistensi Ya/Tidak</div>
                </div>
                <div class="v-box">
                    <div class="label">F - K INDEX</div>
                    <div class="value" id="valFK">-</div>
                    <div class="desc">Gough Dissimulation</div>
                </div>
                <div class="v-box">
                    <div class="label">L (LIE)</div>
                    <div class="value" id="valL">-</div>
                    <div class="desc">T-Score</div>
                </div>
            </div>
            
            <div style="background:#fff3e0; padding:15px; border-left:4px solid #f39c12; font-size:13px; line-height:1.5;">
                <strong>Interpretasi Validitas:</strong>
                <ul style="margin:5px 0 0 20px; padding:0;" id="validityList">
                    <li>Menunggu data...</li>
                </ul>
            </div>
        </div>

        <div class="card" id="klinis">
            <h3>2. Skala Klinis (Basic Scales)</h3>
            <div class="chart-wrapper">
                <canvas id="chartBasic"></canvas>
            </div>
            <div style="margin-bottom:15px; padding:10px; background:#e8f6f3; border-left:4px solid #1abc9c;">
                <strong>Codetype / High Point:</strong> <span id="codetypeText">-</span>
            </div>
            <table id="tblBasic">
                <thead><tr><th>Kode</th><th>Nama Skala</th><th>Raw</th><th>K-Corr</th><th>T-Score</th><th>Keterangan</th></tr></thead>
                <tbody></tbody>
            </table>
        </div>

        <div class="card" id="content">
            <h3>3. Skala Konten (Content Scales)</h3>
            <div class="chart-wrapper"><canvas id="chartContent"></canvas></div>
            <table id="tblContent">
                <thead><tr><th>Kode</th><th>Nama Skala</th><th>Raw</th><th>T-Score</th><th>Keterangan</th></tr></thead>
                <tbody></tbody>
            </table>
        </div>

        <div class="card" id="supp">
            <h3>4. Skala Suplemen (Supplementary)</h3>
            <div class="chart-wrapper"><canvas id="chartSupp"></canvas></div>
            <table id="tblSupp">
                <thead><tr><th>Kode</th><th>Nama Skala</th><th>Raw</th><th>T-Score</th><th>Keterangan</th></tr></thead>
                <tbody></tbody>
            </table>
        </div>

        <div class="card" id="psy5">
            <h3>5. Kepribadian (PSY-5)</h3>
            <div class="chart-wrapper"><canvas id="chartPsy5"></canvas></div>
            <table id="tblPsy5">
                <thead><tr><th>Kode</th><th>Nama Skala</th><th>Raw</th><th>T-Score</th><th>Keterangan</th></tr></thead>
                <tbody></tbody>
            </table>
        </div>
    </div>
</div>

<script>
// ======================================================
// CONFIGURATION & KEYS (Logic Source: Nucular & Standard)
// ======================================================
const KEYS = {
    // Basic Validity & Clinical (Standard MMPI-2)
    basic: {
        'L': { name: 'Lie', i: [15,30,45,75,90,105,120,135,150,165,180,195,210,225,240], t: false },
        'F': { name: 'Infrequency', i: [27,31,33,42,44,46,50,53,62,63,67,68,72,77,85,92,98,102,106,110,111,113,115,116,119,122,124,129,131,132,134,138,142,143,144,146,149,150,156,159,162,163,170,172,175,181,184,187,188,190,192,194,197,198,200,203,206,209,210,215], t: true },
        'K': { name: 'Correction', i: [30,64,96,105,119,120,135,171,180,399,398,407,461,473,520], t: false },
        'Hs': { name: 'Hypochondriasis', i: [2,10,20,47,52,92,141,148,162,182], t: true, k: 0.5 },
        'D': { name: 'Depression', i: [2,5,9,15,24,27,31,33,38,42,46,50,54,55,62,72,75,95,98,102,106,109,114,121,124,136,142,155,160,165,191,235], t: true, k: 0 },
        'Hy': { name: 'Hysteria', i: [3,10,14,16,20,25,34,36,37,40,42,44,47,48,53,57,60,61], t: true, k: 0 },
        'Pd': { name: 'Psychopathic Deviate', i: [12,16,24,27,33,38,42,61,62,67,84,102,106,110,127], t: true, k: 0.4 },
        'Mf': { name: 'Masculinity-Femininity', i: [1,4,19,25,41,52,70,73,77,87], t: true, k: 0 },
        'Pa': { name: 'Paranoia', i: [16,24,27,33,42,61,67,70,74,83], t: true, k: 0 },
        'Pt': { name: 'Psychasthenia', i: [2,5,15,22,27,31,33,38,39,42,44,46,51,55,61,65,67,76,94,100,106,114,127,137,147], t: true, k: 1.0 },
        'Sc': { name: 'Schizophrenia', i: [7,15,23,27,31,33,42,50,60,67,72,78,84,94,100,102,106,109,114,127,136,140,147], t: true, k: 1.0 }, // Sc K is 1.0 in standard
        'Ma': { name: 'Hypomania', i: [12,13,16,19,20,24,34,38,41,42,46], t: true, k: 0.2 },
        'Si': { name: 'Social Introversion', i: [36,52,56,57,62,68,73,74,75,83,92,97,98,102,120,127,130,135,140,147,167,175,191,205,206,210,216,220,229,232], t: true, k: 0 }
    },
    // Content Scales
    content: {
        'ANX': {name:'Anxiety', i:[39,68,76,140,142,150,152,156,161,165,210,293,308,309,339,408], t:true},
        'FRS': {name:'Fears', i:[172,173,179,184,187,190,194,200,203,206,211,213,216,220,224,230,243,304,342,383], t:true},
        'OBS': {name:'Obsessiveness', i:[33,76,109,128,135,152,163,165,199,205,210,213,214,230,293,309,319,333,408], t:true},
        'DEP': {name:'Depression', i:[9,38,39,42,50,54,56,57,62,68,71,73,74,75,92,95,98,100,102,106,109,114,121,124,129,130,131,134,136,140,142,155,160,165,166,167,175,182,191,199,205,207,209,210,211,213,215,229,235], t:true},
        'HEA': {name:'Health Concerns', i:[2,10,20,47,52,92,141,148,155,162,182,192,206,252,267,307,319,339,350,356,359,367,371,378,384,387], t:true},
        'BIZ': {name:'Bizarre Mentation', i:[27,31,33,42,50,66,72,78,84,94,100,102,106,109,114,127,136,140,147,163,190,334,339,350,352,354,362,363], t:true},
        'ANG': {name:'Anger', i:[12,13,16,19,20,24,34,38,41,42,46,95,96,109,114,121,129,138,144,149,152,160,163,165,171,176,183,189,196,202,208,217,219,230,232,242,243,297], t:true},
        'CYN': {name:'Cynicism', i:[27,33,42,61,67,70,74,83,100,102,106,109,114,127,136,140,147,170,172,175,181,184,186,194,208,209,213,217,227,242], t:true},
        'ASP': {name:'Antisocial Practices', i:[12,13,16,19,20,24,34,38,41,42,46,84,102,106,110,116,119,122,132,143,144,149,156,163,167,170,171,175,181,184,201,217,227,242,246,251,266], t:true},
        'TPA': {name:'Type A', i:[27,31,33,42,50,53,57,62,68,72,76,78,85,94,100,102,106,109,114,121,127,136,140,147,152,163,165,170,173,181,184,188,196,211,213,217,223,227,232,242,243,248,253,255,266,276], t:true},
        'LSE': {name:'Low Self-Esteem', i:[51,52,56,57,62,68,73,74,75,83,92,97,98,102,120,127,130,135,140,147,167,175,191,205,206,210,216,220,229,232], t:true},
        'SOD': {name:'Social Discomfort', i:[36,52,56,57,62,68,73,74,75,83,92,97,98,102,120,127,130,135,140,147,167,175], t:true},
        'FAM': {name:'Family Problems', i:[12,16,24,27,33,38,42,61,62,67,213,214,219,223,241,243,244,245,254,290], t:true},
        'WRK': {name:'Work Interference', i:[15,24,38,46,50,54,55,62,72,75,95,98,102,106,109,114,121,124], t:true},
        'TRT': {name:'Negative Treatment', i:[54,55,62,68,72,75,95,98,102,106,109,114,121,124,129,130,131,134,136,140,142,155,160,165,166,167], t:true}
    },
    // Supplementary
    supp: {
        'A': {name:'Anxiety (A)', i:[12,15,22,27,31,33,38,39,42,44,46,51,55,61,65,67,76,94,100,106,114,127,137,147], t:true},
        'R': {name:'Repression (R)', i:[16,25,34,36,37,40,42,44,47,48,53,57,60,61,64,104,105,119,120,135,171,180,399,398,407,461,473,520], t:false},
        'Es': {name:'Ego Strength', i:[7,31,33,42,50,60,67,72,78,84,94,100,102,106,109,114,127,136,140,147,163,190], t:false},
        'MAC-R': {name:'MacAndrew Alcoholism', i:[12,13,16,19,20,24,34,38,41,42,46,84,102,106,110,116,119,122,132,143,144,149,156,163,167], t:true},
        'AAS': {name:'Addiction Admission', i:[27,31,33,42,50,53,57,62,68,72,76,78,85,94,100], t:true},
        'APS': {name:'Addiction Potential', i:[12,13,16,19,20,24,34,38,41,42,46,84,102,106,110,116,119,122], t:true}
    },
    // PSY-5
    psy5: {
        'AGGR': {name:'Aggressiveness', i:[12,13,16,19,20,24,34,38,41,42,46,95,96,109,114,121,129,138,144,149,152,160,163,165,171,176,183,189,196,202,208,217,219,230,232,242,243,297], t:true},
        'PSYC': {name:'Psychoticism', i:[27,31,33,42,50,66,72,78,84,94,100,102,106,109,114,127,136,140,147,163,190,334,339,350,352,354,362,363], t:true},
        'DISC': {name:'Disconstraint', i:[12,13,16,19,20,24,34,38,41,42,46,84,102,106,110,116,119,122,132,143,144,149,156,163,167], t:true},
        'NEGE': {name:'Negative Emotionality', i:[39,42,46,50,54,55,56,57,62,68,72,75,76,95,98,102,106,109,114,121,124,129,130,131,134,136,140,142,152,155,160,161,165,166,167], t:true},
        'INTR': {name:'Introversion', i:[36,52,56,57,62,68,73,74,75,83,92,97,98,102,120,127,130,135,140,147,167,175,191,205,206,210,216,220,229,232], t:true}
    }
};

// TRIN & VRIN PAIRS (Enhanced Logic)
const TRIN_PAIRS = {
    truePairs: [[3,39],[63,127],[99,314],[377,534],[12,166],[65,95],[125,195],[556,560],[40,176],[73,239],[209,351],[48,184],[83,288],[359,367]],
    falsePairs: [[9,56],[140,196],[262,275],[65,95],[152,464],[265,360],[125,195],[165,565],[359,367]]
};

// NORMS (MALE/FEMALE Means & SDs)
const NORMS = {
    male: {
        'L':{m:5.1,s:2.5}, 'F':{m:4.8,s:5.0}, 'K':{m:13.4,s:5.2},
        'Hs':{m:12.8,s:6.0}, 'D':{m:19.0,s:8.4}, 'Hy':{m:20.4,s:7.2}, 'Pd':{m:15.8,s:7.1}, 'Mf':{m:20.7,s:6.8}, 'Pa':{m:9.6,s:6.0}, 'Pt':{m:13.9,s:8.3}, 'Sc':{m:16.1,s:12.4}, 'Ma':{m:13.4,s:5.5}, 'Si':{m:20.9,s:10.7},
        _def: {m:10,s:5}
    },
    female: {
        'L':{m:5.4,s:2.7}, 'F':{m:5.5,s:5.8}, 'K':{m:12.8,s:5.1},
        'Hs':{m:13.5,s:6.5}, 'D':{m:21.3,s:8.8}, 'Hy':{m:21.9,s:7.8}, 'Pd':{m:15.1,s:6.9}, 'Mf':{m:23.4,s:7.2}, 'Pa':{m:10.2,s:6.5}, 'Pt':{m:15.7,s:8.9}, 'Sc':{m:17.5,s:13.2}, 'Ma':{m:14.1,s:5.8}, 'Si':{m:23.8,s:11.2},
        _def: {m:10,s:5}
    }
};
// Fill gaps
Object.keys(KEYS).forEach(k => {
    Object.keys(KEYS[k]).forEach(code => {
        if(!NORMS.male[code]) NORMS.male[code] = {m:10, s:5};
        if(!NORMS.female[code]) NORMS.female[code] = {m:10, s:5};
    });
});

let chartInstances = {};

function processFile(input) {
    const file = input.files[0];
    if(!file) return;
    const reader = new FileReader();
    reader.onload = (e) => {
        try {
            let text = e.target.result.trim();
            if (text.charCodeAt(0) === 0xFEFF) text = text.slice(1);
            text = text.replace(/,(\s*[}\]])/g, '$1'); 
            const data = JSON.parse(text);
            runAnalysis(data);
        } catch(err) {
            document.getElementById('errorMsg').style.display = 'block';
            document.getElementById('errorMsg').innerText = "Error File: " + err.message;
        }
    };
    reader.readAsText(file);
}

function runAnalysis(data) {
    document.getElementById('uploadContainer').classList.add('hidden');
    document.getElementById('reportContainer').classList.remove('hidden');

    // 1. Parse Info
    const bio = data.biodata || {};
    let gender = 'male';
    if(bio.jk && ['P','FEMALE','WANITA','F'].includes(bio.jk.toUpperCase())) gender = 'female';
    
    document.getElementById('dNama').textContent = ": " + (bio.nama || "Anonym");
    document.getElementById('dTanggal').textContent = ": " + new Date().toLocaleDateString();
    document.getElementById('dInfo').textContent = ": " + (bio.usia || "-") + " Th / " + gender.toUpperCase();
    document.getElementById('dEdu').textContent = ": " + (bio.pendidikan || "-");
    document.getElementById('dJob').textContent = ": " + (bio.pekerjaan || "-");

    // 2. Score
    const result = calculateScores(data.answers, gender);
    
    // 3. Render Validity
    renderValidity(result);
    
    // 4. Render Charts & Tables
    renderSection('tblBasic', 'chartBasic', result.basic, true, true);
    renderSection('tblContent', 'chartContent', result.content, false, false);
    renderSection('tblSupp', 'chartSupp', result.supp, false, false);
    renderSection('tblPsy5', 'chartPsy5', result.psy5, false, false);
}

function calculateScores(answers, gender) {
    // A. Helper
    const check = (n, t) => {
        let val = answers[String(n)];
        if(val === undefined) val = answers[n];
        if(val === undefined) return null; // Missing
        val = String(val).toLowerCase();
        const isT = ['true','t','ya','y','1','+'].includes(val);
        if(t && isT) return true;
        if(!t && !isT) return true;
        return false;
    };

    // B. Cannot Say
    let q = 0;
    for(let i=1; i<=567; i++) {
        if(check(i, true) === null) q++;
    }

    // C. TRIN Calculation
    let trinRaw = 9; // Start constant
    TRIN_PAIRS.truePairs.forEach(p => {
        if(check(p[0], true) === true && check(p[1], true) === true) trinRaw++;
    });
    TRIN_PAIRS.falsePairs.forEach(p => {
        if(check(p[0], false) === true && check(p[1], false) === true) trinRaw--; // Actually check(n, false) means answer False matches False logic
        // Correction: check(n, false) returns true if user answered False.
        // So logic: if user answered FALSE to both, subtract 1.
    });
    
    // D. K-Raw for Correction
    let kRaw = 0;
    KEYS.basic.K.i.forEach(n => { if(check(n, KEYS.basic.K.t)) kRaw++; });

    // E. Calculate All Scales
    const out = { basic:{}, content:{}, supp:{}, psy5:{}, valid:{q:q, trin:trinRaw, k:kRaw} };
    
    // Loop Groups
    ['basic','content','supp','psy5'].forEach(grp => {
        for(let code in KEYS[grp]) {
            let conf = KEYS[grp][code];
            let raw = 0;
            conf.i.forEach(n => { if(check(n, conf.t)) raw++; });
            
            let finalRaw = raw;
            let kDisp = '-';
            if(grp === 'basic' && conf.k) {
                let add = Math.round(kRaw * conf.k);
                finalRaw += add;
                kDisp = `+${add}`;
            }
            
            // Linear T-Score (Standard Approx)
            let nm = NORMS[gender][code] || NORMS[gender]._def;
            let t = 50 + (10 * (finalRaw - nm.m) / nm.s);
            
            out[grp][code] = {
                label: conf.name,
                raw: raw,
                finalRaw: finalRaw,
                kDisp: kDisp,
                t: Math.round(t)
            };
        }
    });

    // F-K Index
    out.valid.fk = out.basic.F.raw - out.basic.K.raw;

    return out;
}

function renderValidity(res) {
    // Fill Boxes
    document.getElementById('valQ').textContent = res.valid.q;
    document.getElementById('valQ').style.color = res.valid.q >= 30 ? 'red' : 'black';
    
    // TRIN T-Score (Approximate Male/Female combined)
    // T = 50 + 10(Raw-Mean)/SD. Mean~10, SD~2.
    let trinT = 50 + (10 * (res.valid.trin - 10) / 2); 
    document.getElementById('valTRIN').textContent = Math.round(trinT) + (res.valid.trin >= 13 ? " (T)" : (res.valid.trin <=7 ? " (F)" : ""));
    
    document.getElementById('valFK').textContent = res.valid.fk;
    document.getElementById('valL').textContent = res.basic.L.t;
    document.getElementById('valVRIN').textContent = "Pending"; // VRIN needs full pairs, simple placeholder

    // Interpretasi
    const list = document.getElementById('validityList');
    list.innerHTML = '';
    
    let issues = [];
    if(res.valid.q >= 30) issues.push("Profil INVALID: Terlalu banyak item kosong (Cannot Say > 30).");
    if(res.basic.F.t > 100) issues.push("Profil INVALID: F Scale sangat tinggi, kemungkinan Faking Bad atau distres berat.");
    if(res.basic.L.t > 80 && res.basic.K.t > 80) issues.push("Profil INVALID: Indikasi Faking Good defensif.");
    if(res.valid.fk > 11) issues.push("Indeks F-K Positif: Kecenderungan melebih-lebihkan gejala.");
    if(res.valid.fk < -11) issues.push("Indeks F-K Negatif: Kecenderungan defensif/menyangkal.");
    
    if(issues.length === 0) {
        list.innerHTML = '<li style="color:green">Profil Valid. Tidak ditemukan indikator distorsi yang signifikan.</li>';
        document.getElementById('dValid status').textContent = ": VALID";
        document.getElementById('dValid status').style.color = "green";
    } else {
        issues.forEach(i => list.innerHTML += `<li style="color:red">${i}</li>`);
        document.getElementById('dValid status').textContent = ": INVALID / HATI-HATI";
        document.getElementById('dValid status').style.color = "red";
    }

    // Codetype
    let clinical = ['Hs','D','Hy','Pd','Pa','Pt','Sc','Ma','Si'].map(k => ({k:k, t:res.basic[k].t}));
    clinical.sort((a,b) => b.t - a.t);
    let code = "-";
    if(clinical[0].t >= 65 && clinical[1].t >= 65) {
        code = clinical[0].k + "-" + clinical[1].k + " / " + clinical[1].k + "-" + clinical[0].k;
    } else if(clinical[0].t >= 65) {
        code = "Spike " + clinical[0].k;
    } else {
        code = "Within Normal Limits (WNL)";
    }
    document.getElementById('codetypeText').textContent = code;
}

function renderSection(tblId, chartId, data, useK, sortBasic) {
    const tbody = document.querySelector(`#${tblId} tbody`);
    tbody.innerHTML = '';
    
    let keys = Object.keys(data);
    if(sortBasic) {
        const order = ['L','F','K','Hs','D','Hy','Pd','Mf','Pa','Pt','Sc','Ma','Si'];
        keys = order.filter(k => data[k]);
    }

    const labels = [], values = [], colors = [];
    
    keys.forEach(k => {
        let d = data[k];
        let isHigh = d.t >= 65;
        let badge = isHigh ? '<span class="badge bg-high">TINGGI</span>' : '<span class="badge bg-norm">Normal</span>';
        
        tbody.innerHTML += `<tr class="${isHigh?'highlight':''}">
            <td><strong>${k}</strong></td>
            <td>${d.label}</td>
            <td>${d.raw}</td>
            ${useK ? `<td>${d.kDisp}</td>` : ''}
            <td><strong>${d.t}</strong></td>
            <td>${badge}</td>
        </tr>`;
        
        labels.push(k);
        values.push(d.t);
        colors.push(isHigh ? '#c0392b' : '#34495e');
    });

    // Chart
    new Chart(document.getElementById(chartId), {
        type: 'line',
        data: {
            labels: labels,
            datasets: [{
                label: 'T-Score',
                data: values,
                borderColor: '#2c3e50',
                backgroundColor: 'rgba(52, 152, 219, 0.1)',
                pointBackgroundColor: colors,
                pointRadius: 5,
                borderWidth: 2,
                fill: true
            }]
        },
        options: {
            maintainAspectRatio: false,
            scales: {
                y: {
                    min: 30, max: 120,
                    grid: { color: v => v.tick.value===65 ? 'red' : '#eee', lineWidth: v=>v.tick.value===65?2:1, borderDash: v=>v.tick.value===65?[5,5]:[] }
                }
            },
            plugins: { legend: {display:false} }
        }
    });
}
</script>
</body>
</html>
