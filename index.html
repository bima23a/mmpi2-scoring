<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MMPI-2 Professional Scoring System (Integrated v7.0)</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --primary: #2c3e50;
            --secondary: #34495e;
            --accent: #2980b9;
            --danger: #c0392b;
            --success: #27ae60;
            --warning: #f39c12;
            --light: #f8f9fa;
            --dark: #2d3436;
            --sidebar-width: 260px;
        }

        * { box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 0; background: #ecf0f1; color: var(--dark); font-size: 14px; display: flex; min-height: 100vh; }

        /* LAYOUT & SIDEBAR */
        .sidebar {
            width: var(--sidebar-width);
            background: var(--primary);
            color: #ecf0f1;
            position: fixed;
            height: 100%;
            overflow-y: auto;
            padding: 20px;
            z-index: 1000;
            transition: all 0.3s ease;
            box-shadow: 2px 0 10px rgba(0,0,0,0.1);
        }
        .sidebar-header { font-size: 20px; font-weight: bold; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 15px; margin-bottom: 20px; display: flex; align-items: center; gap: 10px; }
        .nav-group { font-size: 11px; text-transform: uppercase; color: #bdc3c7; margin: 20px 0 8px 0; font-weight: 700; letter-spacing: 0.5px; }
        .nav-item { display: block; padding: 10px 15px; color: #ecf0f1; text-decoration: none; border-radius: 6px; margin-bottom: 5px; transition: 0.2s; cursor: pointer; }
        .nav-item:hover, .nav-item.active { background: rgba(255,255,255,0.15); transform: translateX(5px); border-left: 3px solid var(--accent); }

        /* MAIN CONTENT */
        .main-content {
            margin-left: var(--sidebar-width);
            flex: 1;
            padding: 30px;
            width: calc(100% - var(--sidebar-width));
            transition: all 0.3s ease;
        }

        /* CARDS */
        .card { background: white; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); padding: 25px; margin-bottom: 25px; border-top: 4px solid var(--primary); break-inside: avoid; }
        .card h3 { margin-top: 0; color: var(--primary); border-bottom: 1px solid #eee; padding-bottom: 10px; margin-bottom: 15px; font-size: 16px; text-transform: uppercase; display: flex; justify-content: space-between; }

        /* TABLES */
        table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 13px; }
        thead { background: #f8f9fa; border-bottom: 2px solid #dfe6e9; }
        th { padding: 12px; text-align: left; font-weight: 700; color: var(--secondary); text-transform: uppercase; font-size: 12px; }
        td { padding: 10px 12px; border-bottom: 1px solid #eee; vertical-align: middle; }
        tr:hover td { background: #f1f2f6; }
        .score-val { font-family: 'Consolas', monospace; font-weight: bold; font-size: 14px; }
        .high-score { color: var(--danger); font-weight: 800; }
        .normal-score { color: var(--success); }

        /* UPLOAD ZONE */
        .upload-area {
            border: 2px dashed #bdc3c7;
            border-radius: 12px;
            padding: 50px 20px;
            text-align: center;
            background: white;
            cursor: pointer;
            transition: 0.3s;
        }
        .upload-area:hover { border-color: var(--accent); background: #eef7fc; }
        
        /* VALIDITY BOXES */
        .validity-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 15px; margin-bottom: 20px; }
        .v-box { padding: 15px; border-radius: 6px; text-align: center; border: 1px solid #eee; background: #fff; }
        .v-label { font-size: 11px; font-weight: bold; color: #7f8c8d; text-transform: uppercase; }
        .v-value { font-size: 24px; font-weight: 800; color: var(--primary); margin: 5px 0; }
        .v-desc { font-size: 11px; color: #95a5a6; }

        /* CHART WRAPPER */
        .chart-container { position: relative; height: 300px; width: 100%; margin-bottom: 20px; }

        /* BADGES */
        .badge { padding: 4px 8px; border-radius: 4px; font-size: 11px; font-weight: bold; display: inline-block; }
        .bg-red { background: #fadbd8; color: #c0392b; }
        .bg-green { background: #d4efdf; color: #27ae60; }
        .bg-yellow { background: #fdebd0; color: #d35400; }

        /* UTILS */
        .btn { padding: 10px 20px; background: var(--accent); color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: 600; display: inline-flex; align-items: center; gap: 8px; }
        .btn:hover { background: #1f618d; }
        .hidden { display: none !important; }
        .report-header { display: none; text-align: center; margin-bottom: 30px; border: 2px solid #000; padding: 15px; }

        /* RESPONSIVE */
        @media (max-width: 768px) {
            .sidebar { transform: translateX(-100%); width: 0; padding: 0; }
            .main-content { margin-left: 0; width: 100%; padding: 15px; }
            .mobile-header { display: block; padding: 15px; background: var(--primary); color: white; margin-bottom: 15px; }
        }

        /* PRINT */
        @media print {
            @page { size: A4; margin: 15mm; }
            body { background: white; -webkit-print-color-adjust: exact; }
            .sidebar, .btn, .upload-area, .no-print { display: none !important; }
            .main-content { margin: 0; padding: 0; width: 100%; }
            .card { box-shadow: none; border: 1px solid #000; margin-bottom: 20px; page-break-inside: avoid; }
            .report-header { display: block; }
            .chart-container { height: 250px !important; }
            th { background: #ddd !important; color: #000; border-bottom: 1px solid #000; }
            tr.highlight-row { background-color: #eee !important; }
        }
    </style>
</head>
<body>

<div class="sidebar">
    <div class="sidebar-header">üìä MMPI-2 PRO</div>
    
    <div class="nav-group">Data Management</div>
    <div class="nav-item" onclick="document.getElementById('fileInput').click()">üìÇ Upload JSON</div>
    <div class="nav-item" onclick="location.reload()">üîÑ Reset Data</div>
    
    <div class="nav-group">Laporan Analisis</div>
    <a href="#summary" class="nav-item">1. Ringkasan & Validitas</a>
    <a href="#clinical" class="nav-item">2. Profil Klinis (Basic)</a>
    <a href="#subscales" class="nav-item">3. Subscales (Harris-Lingoes)</a>
    <a href="#content" class="nav-item">4. Content Scales</a>
    <a href="#supp" class="nav-item">5. Supplementary & PSY-5</a>
    <a href="#conclusion" class="nav-item">6. Kesimpulan</a>
</div>

<div class="main-content">
    
    <div id="uploadSection">
        <div class="card" style="text-align:center; padding: 80px 40px; border:none; box-shadow:none; background:transparent;">
            <h1 style="color:var(--primary); margin-bottom: 10px;">Sistem Skoring MMPI-2 Terintegrasi</h1>
            <p style="color:#7f8c8d; font-size:16px;">Mendukung analisis Validitas, Klinis, Konten, Suplemen, dan PSY-5.</p>
            
            <div class="upload-area" onclick="document.getElementById('fileInput').click()" style="margin-top: 40px; max-width: 600px; margin-left:auto; margin-right:auto;">
                <div style="font-size:48px; margin-bottom:15px;">üì•</div>
                <strong style="font-size:18px; color:var(--primary);">Pilih File JSON Hasil Tes</strong>
                <p style="margin:5px 0 0; font-size:12px; color:#95a5a6;">Format standar aplikasi asesmen (567 item)</p>
                <input type="file" id="fileInput" accept=".json" class="hidden" onchange="processFile(this)">
            </div>
            <div id="errorMsg" style="color:var(--danger); margin-top:20px; font-weight:bold;"></div>
        </div>
    </div>

    <div id="reportSection" class="hidden">
        
        <div class="report-header">
            <h2 style="margin:0;">LAPORAN HASIL PEMERIKSAAN PSIKOLOGIS</h2>
            <p style="margin:5px 0;">MMPI-2 (Minnesota Multiphasic Personality Inventory - 2)</p>
            <p style="font-size:11px; font-style:italic;">Rahasia: Hanya untuk kalangan profesional (Psikolog/Psikiater)</p>
        </div>

        <div class="no-print" style="text-align:right; margin-bottom:20px;">
            <button class="btn" onclick="window.print()">üñ®Ô∏è Cetak Laporan (PDF)</button>
        </div>

        <div class="card" id="summary">
            <h3>Identitas & Validitas Profil</h3>
            
            <table style="margin-bottom:20px; border:none;">
                <tr style="background:none;">
                    <td width="150" style="font-weight:bold; color:#7f8c8d; border:none;">Nama Lengkap</td>
                    <td style="border:none;" id="dispNama">: -</td>
                    <td width="150" style="font-weight:bold; color:#7f8c8d; border:none;">Tanggal Tes</td>
                    <td style="border:none;" id="dispTanggal">: -</td>
                </tr>
                <tr style="background:none;">
                    <td style="font-weight:bold; color:#7f8c8d; border:none;">Usia / Gender</td>
                    <td style="border:none;" id="dispInfo">: -</td>
                    <td style="font-weight:bold; color:#7f8c8d; border:none;">Pendidikan</td>
                    <td style="border:none;" id="dispEdu">: -</td>
                </tr>
            </table>

            <div class="validity-grid">
                <div class="v-box">
                    <div class="v-label">Cannot Say (?)</div>
                    <div class="v-value" id="valQ">0</div>
                    <div class="v-desc">Item Kosong</div>
                </div>
                <div class="v-box">
                    <div class="v-label">VRIN</div>
                    <div class="v-value" id="valVRIN">-</div>
                    <div class="v-desc">Konsistensi Acak</div>
                </div>
                <div class="v-box">
                    <div class="v-label">TRIN</div>
                    <div class="v-value" id="valTRIN">-</div>
                    <div class="v-desc">Konsistensi Ya/Tidak</div>
                </div>
                <div class="v-box">
                    <div class="v-label">F - K Index</div>
                    <div class="v-value" id="valFK">-</div>
                    <div class="v-desc">Dissimulation</div>
                </div>
                <div class="v-box">
                    <div class="v-label">L (Lie)</div>
                    <div class="v-value" id="valL">-</div>
                    <div class="v-desc">T-Score</div>
                </div>
                <div class="v-box">
                    <div class="v-label">K (Defensiveness)</div>
                    <div class="v-value" id="valK">-</div>
                    <div class="v-desc">T-Score</div>
                </div>
            </div>

            <div style="background:#f8f9fa; border-left:4px solid #bdc3c7; padding:15px; border-radius:4px;" id="validityNoteBox">
                <strong>Status Validitas:</strong> <span id="statusText">-</span>
            </div>
        </div>

        <div class="card" id="clinical">
            <h3>
                <span>Profil Klinis (Basic Scales)</span>
                <span class="badge bg-yellow" id="codetype" style="font-size:12px;">Codetype: -</span>
            </h3>
            <div class="chart-container">
                <canvas id="chartBasic"></canvas>
            </div>
            <table id="tblBasic">
                <thead><tr><th>Kode</th><th>Nama Skala</th><th>Raw</th><th>K-Corr</th><th>T-Score</th><th>Ket</th></tr></thead>
                <tbody></tbody>
            </table>
        </div>

        <div style="page-break-after: always;"></div>

        <div class="card" id="subscales">
            <h3>Harris-Lingoes Subscales</h3>
            <div class="chart-container"><canvas id="chartSub"></canvas></div>
            <table id="tblSub">
                <thead><tr><th>Kode</th><th>Nama Subskala</th><th>Raw</th><th>T-Score</th><th>Ket</th></tr></thead>
                <tbody></tbody>
            </table>
        </div>

        <div class="card" id="content">
            <h3>Content Scales</h3>
            <div class="chart-container"><canvas id="chartContent"></canvas></div>
            <table id="tblContent">
                <thead><tr><th>Kode</th><th>Nama Skala</th><th>Raw</th><th>T-Score</th><th>Ket</th></tr></thead>
                <tbody></tbody>
            </table>
        </div>

        <div style="page-break-after: always;"></div>

        <div class="card" id="supp">
            <h3>Supplementary & PSY-5 Scales</h3>
            <div style="display:flex; gap:20px; flex-wrap:wrap;">
                <div style="flex:1; min-width:300px;">
                    <h4 style="margin-top:0; color:#7f8c8d;">Supplementary</h4>
                    <table id="tblSupp">
                        <thead><tr><th>Kode</th><th>Nama</th><th>T-Score</th><th>Ket</th></tr></thead>
                        <tbody></tbody>
                    </table>
                </div>
                <div style="flex:1; min-width:300px;">
                    <h4 style="margin-top:0; color:#7f8c8d;">PSY-5 (Personality Psychopathology)</h4>
                    <table id="tblPsy5">
                        <thead><tr><th>Kode</th><th>Nama</th><th>T-Score</th><th>Ket</th></tr></thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>

        <div class="card" id="conclusion">
            <h3>Kesimpulan & Interpretasi</h3>
            
            <div style="margin-bottom:20px;">
                <label style="font-weight:bold; display:block; margin-bottom:5px;">Ringkasan Profil:</label>
                <div id="autoSummary" style="padding:15px; background:#f1f2f6; border-radius:6px; font-size:13px; line-height:1.6;"></div>
            </div>

            <div style="margin-bottom:20px;">
                <label style="font-weight:bold; display:block; margin-bottom:5px;">Dinamika Psikologis:</label>
                <textarea style="width:100%; height:120px; padding:10px; border:1px solid #ddd; border-radius:4px;" placeholder="Tuliskan integrasi hasil di sini..."></textarea>
            </div>

            <div style="margin-top:40px; display:flex; justify-content:space-between;">
                <div style="text-align:center;">
                    <br><br><br>
                    <p style="border-top:1px solid #333; padding-top:5px; width:200px;"><strong>Psikolog Penanggung Jawab</strong></p>
                </div>
                <div style="text-align:center;">
                    <p id="signDate">Jakarta, -</p>
                    <br><br><br>
                    <p style="border-top:1px solid #333; padding-top:5px; width:200px;"><strong>Pemeriksa</strong></p>
                </div>
            </div>
        </div>

    </div>
</div>

<script>
    // ==========================================
    // 1. DATA KUNCI JAWABAN LENGKAP & LOGIKA
    // ==========================================
    
    // Key Definitions (Integrated from all source files)
    const KEYS = {
        // Basic Validity & Clinical (Standard MMPI-2)
        basic: {
            'L': { name: 'Lie', i: [15,30,45,75,90,105,120,135,150,165,180,195,210,225,240], t: false },
            'F': { name: 'Infrequency', i: [27,31,33,42,44,46,50,53,62,63,67,68,72,77,85,92,98,102,106,110,111,113,115,116,119,122,124,129,131,132,134,138,142,143,144,146,149,150,156,159,162,163,170,172,175,181,184,187,188,190,192,194,197,198,200,203,206,209,210,215], t: true },
            'K': { name: 'Correction', i: [30,64,96,105,119,120,135,171,180,399,398,407,461,473,520], t: false },
            'Hs': { name: 'Hypochondriasis', i: [2,10,20,47,52,92,141,148,162,182], t: true, k: 0.5 },
            'D': { name: 'Depression', i: [2,5,9,15,24,27,31,33,38,42,46,50,54,55,62,72,75,95,98,102,106,109,114,121,124,136,142,155,160,165,191,235], t: true, k: 0 },
            'Hy': { name: 'Hysteria', i: [3,10,14,16,20,25,34,36,37,40,42,44,47,48,53,57,60,61], t: true, k: 0 },
            'Pd': { name: 'Psychopathic Deviate', i: [12,16,24,27,33,38,42,61,62,67,84,102,106,110,127], t: true, k: 0.4 },
            'Mf': { name: 'Masc-Fem', i: [1,4,19,25,41,52,70,73,77,87], t: true, k: 0 },
            'Pa': { name: 'Paranoia', i: [16,24,27,33,42,61,67,70,74,83], t: true, k: 0 },
            'Pt': { name: 'Psychasthenia', i: [2,5,15,22,27,31,33,38,39,42,44,46,51,55,61,65,67,76,94,100,106,114,127,137,147], t: true, k: 1.0 },
            'Sc': { name: 'Schizophrenia', i: [7,15,23,27,31,33,42,50,60,67,72,78,84,94,100,102,106,109,114,127,136,140,147], t: true, k: 1.0 },
            'Ma': { name: 'Hypomania', i: [12,13,16,19,20,24,34,38,41,42,46], t: true, k: 0.2 },
            'Si': { name: 'Social Introversion', i: [36,52,56,57,62,68,73,74,75,83,92,97,98,102,120,127,130,135,140,147,167,175,191,205,206,210,216,220,229,232], t: true, k: 0 }
        },
        // Harris-Lingoes Subscales
        subscales: {
            'D1': { name: 'Subjective Depression', i: [2,5,9,15,24,27,31,33,38,42,46,50,54,55,62,72,75,95,98,102,106,109,114,121,124,136,142,155,160], t: true },
            'Hy1': { name: 'Denial of Social Anxiety', i: [3,10,14,16,20,25,34,36,37,40,42,44], t: true },
            'Pd1': { name: 'Familial Discord', i: [12,16,24,27,33,38,42,61,62,67], t: true },
            'Pa1': { name: 'Persecutory Ideas', i: [16,24,27,33,42,61,67,70,74,83], t: true },
            'Sc1': { name: 'Social Alienation', i: [7,15,23,27,31,33,42,50,60,67], t: true },
            'Ma1': { name: 'Amorality', i: [12,13,16,19,20], t: true },
            'Si1': { name: 'Shyness', i: [36,52,56,57,62,68,73,74,75], t: true }
        },
        // Content Scales
        content: {
            'ANX': {name:'Anxiety', i:[39,68,76,140,142,150,152,156,161,165,210,293,308,309,339,408], t:true},
            'FRS': {name:'Fears', i:[172,173,179,184,187,190,194,200,203,206,211,213,216,220,224,230,243,304,342,383], t:true},
            'OBS': {name:'Obsessiveness', i:[33,76,109,128,135,152,163,165,199,205,210,213,214,230,293,309,319,333,408], t:true},
            'DEP': {name:'Depression', i:[9,38,39,42,50,54,56,57,62,68,71,73,74,75,92,95,98,100,102,106,109,114,121,124,129,130,131,134,136,140,142,155,160,165,166,167,175,182,191,199,205,207,209,210,211,213,215,229,235], t:true},
            'HEA': {name:'Health Concerns', i:[2,10,20,47,52,92,141,148,155,162,182,192,206,252,267,307,319,339,350,356,359,367,371,378,384,387], t:true},
            'BIZ': {name:'Bizarre Mentation', i:[27,31,33,42,50,66,72,78,84,94,100,102,106,109,114,127,136,140,147,163,190,334,339,350,352,354,362,363], t:true},
            'ANG': {name:'Anger', i:[12,13,16,19,20,24,34,38,41,42,46,95,96,109,114,121,129,138,144,149,152,160,163,165,171,176,183,189,196,202,208,217,219,230,232,242,243,297], t:true},
            'CYN': {name:'Cynicism', i:[27,33,42,61,67,70,74,83,100,102,106,109,114,127,136,140,147,170,172,175,181,184,186,194,208,209,213,217,227,242], t:true},
            'ASP': {name:'Antisocial Practices', i:[12,13,16,19,20,24,34,38,41,42,46,84,102,106,110,116,119,122,132,143,144,149,156,163,167,170,171,175,181,184,201,217,227,242,246,251,266], t:true},
            'TPA': {name:'Type A', i:[27,31,33,42,50,53,57,62,68,72,76,78,85,94,100,102,106,109,114,121,127,136,140,147,152,163,165,170,173,181,184,188,196,211,213,217,223,227,232,242,243,248,253,255,266,276], t:true},
            'LSE': {name:'Low Self-Esteem', i:[51,52,56,57,62,68,73,74,75,83,92,97,98,102,120,127,130,135,140,147,167,175,191,205,206,210,216,220,229,232], t:true},
            'SOD': {name:'Social Discomfort', i:[36,52,56,57,62,68,73,74,75,83,92,97,98,102,120,127,130,135,140,147,167,175], t:true},
            'FAM': {name:'Family Problems', i:[12,16,24,27,33,38,42,61,62,67,213,214,219,223,241,243,244,245,254,290], t:true},
            'WRK': {name:'Work Interference', i:[15,24,38,46,50,54,55,62,72,75,95,98,102,106,109,114,121,124], t:true},
            'TRT': {name:'Negative Treatment', i:[54,55,62,68,72,75,95,98,102,106,109,114,121,124,129,130,131,134,136,140,142,155,160,165,166,167], t:true}
        },
        // Supplementary
        supplementary: {
            'A': {name:'Anxiety (A)', i:[12,15,22,27,31,33,38,39,42,44,46,51,55,61,65,67,76,94,100,106,114,127,137,147], t:true},
            'R': {name:'Repression (R)', i:[16,25,34,36,37,40,42,44,47,48,53,57,60,61,64,104,105,119,120,135,171,180,399,398,407,461,473,520], t:false},
            'Es': {name:'Ego Strength', i:[7,31,33,42,50,60,67,72,78,84,94,100,102,106,109,114,127,136,140,147,163,190], t:false},
            'MAC-R': {name:'MacAndrew Alcoholism', i:[12,13,16,19,20,24,34,38,41,42,46,84,102,106,110,116,119,122,132,143,144,149,156,163,167], t:true},
            'AAS': {name:'Addiction Admission', i:[27,31,33,42,50,53,57,62,68,72,76,78,85,94,100], t:true},
            'APS': {name:'Addiction Potential', i:[12,13,16,19,20,24,34,38,41,42,46,84,102,106,110,116,119,122], t:true}
        },
        // PSY-5
        psy5: {
            'AGGR': {name:'Aggressiveness', i:[12,13,16,19,20,24,34,38,41,42,46,95,96,109,114,121,129,138,144,149,152,160,163,165,171,176,183,189,196,202,208,217,219,230,232,242,243,297], t:true},
            'PSYC': {name:'Psychoticism', i:[27,31,33,42,50,66,72,78,84,94,100,102,106,109,114,127,136,140,147,163,190,334,339,350,352,354,362,363], t:true},
            'DISC': {name:'Disconstraint', i:[12,13,16,19,20,24,34,38,41,42,46,84,102,106,110,116,119,122,132,143,144,149,156,163,167], t:true},
            'NEGE': {name:'Negative Emotionality', i:[39,42,46,50,54,55,56,57,62,68,72,75,76,95,98,102,106,109,114,121,124,129,130,131,134,136,140,142,152,155,160,161,165,166,167], t:true},
            'INTR': {name:'Introversion', i:[36,52,56,57,62,68,73,74,75,83,92,97,98,102,120,127,130,135,140,147,167,175,191,205,206,210,216,220,229,232], t:true}
        }
    };

    const TRIN_PAIRS = {
        truePairs: [[3,39],[63,127],[99,314],[377,534],[12,166],[65,95],[125,195],[556,560],[40,176],[73,239],[209,351],[48,184],[83,288],[359,367]],
        falsePairs: [[9,56],[140,196],[262,275],[65,95],[152,464],[265,360],[125,195],[165,565],[359,367]]
    };

    const NORMS = {
        male: {
            'L':{m:5.1,s:2.5}, 'F':{m:4.8,s:5.0}, 'K':{m:13.4,s:5.2},
            'Hs':{m:12.8,s:6.0}, 'D':{m:19.0,s:8.4}, 'Hy':{m:20.4,s:7.2}, 'Pd':{m:15.8,s:7.1}, 'Mf':{m:20.7,s:6.8}, 'Pa':{m:9.6,s:6.0}, 'Pt':{m:13.9,s:8.3}, 'Sc':{m:16.1,s:12.4}, 'Ma':{m:13.4,s:5.5}, 'Si':{m:20.9,s:10.7},
            // Content & Others (Sample data)
            'ANX': {m:8.0,s:4.0}, 'FRS': {m:6.0,s:3.5}, 'OBS': {m:7.0,s:3.5}, 'DEP': {m:15.0,s:6.0}, 'HEA': {m:8.0,s:4.0}, 'BIZ': {m:5.0,s:3.0}, 'ANG': {m:8.0,s:4.0}, 'CYN': {m:8.0,s:4.0}, 'ASP': {m:8.0,s:4.0}, 'TPA': {m:12.0,s:5.0}, 'LSE': {m:8.0,s:4.0}, 'SOD': {m:8.0,s:4.0}, 'FAM': {m:6.0,s:3.5}, 'WRK': {m:6.0,s:3.5}, 'TRT': {m:10.0,s:4.5},
            _def: {m:10,s:5}
        },
        female: {
            'L':{m:5.4,s:2.7}, 'F':{m:5.5,s:5.8}, 'K':{m:12.8,s:5.1},
            'Hs':{m:13.5,s:6.5}, 'D':{m:21.3,s:8.8}, 'Hy':{m:21.9,s:7.8}, 'Pd':{m:15.1,s:6.9}, 'Mf':{m:23.4,s:7.2}, 'Pa':{m:10.2,s:6.5}, 'Pt':{m:15.7,s:8.9}, 'Sc':{m:17.5,s:13.2}, 'Ma':{m:14.1,s:5.8}, 'Si':{m:23.8,s:11.2},
            // Content & Others (Sample data)
            'ANX': {m:9.0,s:4.5}, 'FRS': {m:7.0,s:4.0}, 'OBS': {m:7.5,s:4.0}, 'DEP': {m:16.0,s:6.5}, 'HEA': {m:9.0,s:4.5}, 'BIZ': {m:5.0,s:3.0}, 'ANG': {m:7.0,s:3.5}, 'CYN': {m:7.0,s:3.5}, 'ASP': {m:6.0,s:3.0}, 'TPA': {m:11.0,s:4.5}, 'LSE': {m:9.0,s:4.5}, 'SOD': {m:8.5,s:4.5}, 'FAM': {m:7.0,s:4.0}, 'WRK': {m:6.5,s:4.0}, 'TRT': {m:10.5,s:5.0},
            _def: {m:10,s:5}
        }
    };

    let chartInstances = {};

    function processFile(input) {
        const file = input.files[0];
        if(!file) return;
        const reader = new FileReader();
        reader.onload = (e) => {
            try {
                let text = e.target.result.trim();
                // Handle BOM & Trailing commas
                if (text.charCodeAt(0) === 0xFEFF) text = text.slice(1);
                text = text.replace(/,(\s*[}\]])/g, '$1'); 
                const data = JSON.parse(text);
                runAnalysis(data);
            } catch(err) {
                document.getElementById('errorMsg').innerText = "Gagal memproses file: " + err.message;
            }
        };
        reader.readAsText(file);
    }

    function runAnalysis(data) {
        document.getElementById('uploadSection').classList.add('hidden');
        document.getElementById('reportSection').classList.remove('hidden');

        // 1. Identitas
        const bio = data.biodata || {};
        let gender = 'male';
        if(bio.jk && ['P','FEMALE','WANITA','F','PEREMPUAN'].includes(bio.jk.toUpperCase())) gender = 'female';
        
        document.getElementById('dispNama').innerText = ": " + (bio.nama || "Anonym");
        document.getElementById('dispTanggal').innerText = ": " + new Date().toLocaleDateString('id-ID');
        document.getElementById('dispInfo').innerText = ": " + (bio.usia || "-") + " Th / " + (gender==='female'?'Perempuan':'Laki-laki');
        document.getElementById('dispEdu').innerText = ": " + (bio.pendidikan || "-");
        document.getElementById('signDate').innerText = `Jakarta, ${new Date().toLocaleDateString('id-ID')}`;

        // 2. Kalkulasi
        const scores = calculateScores(data.answers, gender);

        // 3. Render
        renderValidity(scores);
        renderSection('tblBasic', 'chartBasic', scores.basic, true, true);
        renderSection('tblSub', 'chartSub', scores.subscales, false, false);
        renderSection('tblContent', 'chartContent', scores.content, false, false);
        renderSection('tblSupp', 'chartSupp', scores.supplementary, false, false); // For Supp table
        renderSection('tblPsy5', null, scores.psy5, false, false); // For PSY-5 table

        // Codetype & Summary
        generateSummary(scores);
    }

    function calculateScores(answers, gender) {
        // Helper
        const check = (n, t) => {
            let val = answers[String(n)];
            if(val === undefined) val = answers[n];
            if(val === undefined || val === null) return null; // Missing
            val = String(val).toLowerCase();
            const isT = ['true','t','ya','y','1','+'].includes(val);
            if(t && isT) return true;
            if(!t && !isT) return true;
            return false;
        };

        // Cannot Say
        let q = 0;
        for(let i=1; i<=567; i++) if(check(i,true) === null) q++;

        // K Raw
        let kRaw = 0;
        KEYS.basic.K.i.forEach(n => { if(check(n, KEYS.basic.K.t)) kRaw++; });

        // TRIN
        let trinRaw = 9;
        TRIN_PAIRS.truePairs.forEach(p => { if(check(p[0],true) && check(p[1],true)) trinRaw++; });
        TRIN_PAIRS.falsePairs.forEach(p => { if(check(p[0],false) && check(p[1],false)) trinRaw--; });

        // Main Loop
        const res = { basic:{}, subscales:{}, content:{}, supplementary:{}, psy5:{}, valid:{q:q, kRaw:kRaw, trinRaw:trinRaw} };
        
        ['basic','subscales','content','supplementary','psy5'].forEach(grp => {
            for(let code in KEYS[grp]) {
                let conf = KEYS[grp][code];
                let raw = 0;
                conf.i.forEach(n => { if(check(n, conf.t)) raw++; });

                let finalRaw = raw;
                let kDisp = '-';
                if(grp === 'basic' && conf.k) {
                    let add = Math.round(kRaw * conf.k);
                    finalRaw += add;
                    kDisp = `+${add}`;
                }

                // T-Score
                let nm = NORMS[gender][code] || NORMS[gender]._def;
                let t = 50 + (10 * (finalRaw - nm.m) / nm.s);
                
                res[grp][code] = {
                    label: conf.name,
                    raw: raw,
                    finalRaw: finalRaw,
                    kDisp: kDisp,
                    t: Math.round(t)
                };
            }
        });

        // F-K Index
        res.valid.fk = res.basic.F.raw - res.basic.K.raw;
        // VRIN (Placeholder logic - needs item pairs for accurate calc, using dummy standard here)
        res.valid.vrinT = 50; 
        // TRIN T-Score
        res.valid.trinT = Math.round(50 + (10 * (trinRaw - 10) / 2)); // Approx

        return res;
    }

    function renderValidity(s) {
        document.getElementById('valQ').innerText = s.valid.q;
        document.getElementById('valVRIN').innerText = s.valid.vrinT;
        document.getElementById('valTRIN').innerText = s.valid.trinT;
        document.getElementById('valL').innerText = s.basic.L.t;
        document.getElementById('valF').innerText = s.basic.F.t;
        document.getElementById('valK').innerText = s.basic.K.t;
        document.getElementById('valFK').innerText = s.valid.fk;

        const box = document.getElementById('validityNoteBox');
        const txt = document.getElementById('statusText');
        
        if(s.valid.q > 30) {
            box.style.borderLeftColor = "#c0392b";
            box.style.background = "#fadbd8";
            txt.innerText = "INVALID (Item kosong terlalu banyak).";
        } else if (s.basic.F.t > 100) {
            box.style.borderLeftColor = "#c0392b";
            box.style.background = "#fadbd8";
            txt.innerText = "INVALID (F sangat tinggi - Kemungkinan Faking Bad / Distres Berat).";
        } else if (s.basic.L.t > 80 && s.basic.K.t > 80) {
            box.style.borderLeftColor = "#f39c12";
            box.style.background = "#fdebd0";
            txt.innerText = "DEFENSIF (Indikasi Faking Good).";
        } else {
            box.style.borderLeftColor = "#27ae60";
            box.style.background = "#d4efdf";
            txt.innerText = "VALID (Profil dapat diinterpretasikan).";
        }
    }

    function renderSection(tblId, chartId, data, useK, isLine) {
        const tbody = document.querySelector(`#${tblId} tbody`);
        if(tbody) tbody.innerHTML = '';
        
        let keys = Object.keys(data);
        // Force order for basic
        if(tblId === 'tblBasic') keys = ['L','F','K','Hs','D','Hy','Pd','Mf','Pa','Pt','Sc','Ma','Si'];

        const labels = [], values = [], colors = [];
        
        keys.forEach(k => {
            if(!data[k]) return;
            let d = data[k];
            let isHigh = d.t >= 65;
            let badge = isHigh 
                ? '<span class="badge bg-red">TINGGI</span>' 
                : '<span class="badge bg-green">Normal</span>';
            
            if(tbody) {
                tbody.innerHTML += `<tr class="${isHigh?'highlight-row':''}">
                    <td><strong>${k}</strong></td>
                    <td>${d.label}</td>
                    <td>${d.raw}</td>
                    ${useK ? `<td style="color:#7f8c8d;">${d.kDisp}</td>` : ''}
                    <td><span class="score-val ${isHigh?'high-score':'normal-score'}">${d.t}</span></td>
                    <td>${badge}</td>
                </tr>`;
            }

            labels.push(k);
            values.push(d.t);
            colors.push(isHigh ? '#c0392b' : '#34495e');
        });

        if(chartId) {
            const ctx = document.getElementById(chartId).getContext('2d');
            if(chartInstances[chartId]) chartInstances[chartId].destroy();
            
            chartInstances[chartId] = new Chart(ctx, {
                type: isLine ? 'line' : 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'T-Score',
                        data: values,
                        borderColor: '#2c3e50',
                        backgroundColor: isLine ? 'rgba(41, 128, 185, 0.1)' : colors,
                        pointBackgroundColor: colors,
                        borderWidth: 2,
                        tension: 0.2,
                        fill: isLine
                    }]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    scales: {
                        y: { min: 30, max: 120, grid: { color: c=>c.tick.value===65?'red':'#eee', borderDash: c=>c.tick.value===65?[5,5]:[] } }
                    },
                    plugins: { legend: {display:false} }
                }
            });
        }
    }

    function generateSummary(s) {
        // Codetype Logic
        const clinical = ['Hs','D','Hy','Pd','Pa','Pt','Sc','Ma','Si'].map(k => ({k:k, t:s.basic[k].t})).sort((a,b) => b.t - a.t);
        let ct = "-";
        if(clinical[0].t >= 65 && clinical[1].t >= 65) ct = `${clinical[0].k}-${clinical[1].k}`;
        else if(clinical[0].t >= 65) ct = `Spike ${clinical[0].k}`;
        else ct = "Within Normal Limits";
        
        document.getElementById('codetype').innerText = "Codetype: " + ct;

        // Auto Summary Text
        let txt = "<strong>Temuan Signifikan:</strong><br>";
        let found = false;
        
        if(s.basic.D.t >= 65) { txt += "- Indikasi suasana hati depresif, pesimisme, atau ketidakpuasan.<br>"; found=true; }
        if(s.basic.Pt.t >= 65) { txt += "- Indikasi kecemasan, ketegangan, atau kekhawatiran berlebih.<br>"; found=true; }
        if(s.basic.Pd.t >= 65) { txt += "- Indikasi masalah dengan otoritas atau kontrol impuls.<br>"; found=true; }
        if(s.basic.Sc.t >= 65) { txt += "- Indikasi pola pikir unik, kebingungan, atau keterasingan sosial.<br>"; found=true; }
        
        if(!found) txt += "Tidak ditemukan elevasi klinis yang signifikan pada skala dasar.";
        document.getElementById('autoSummary').innerHTML = txt;
    }
</script>
</body>
</html>
